name: Test Solr Action Release

on:
  push:
    tags:
      - "v[0-9]"   # Major version release (e.g., v1, v2, ..., v9)

jobs:
  # -----------------------------
  # Job 1: Solr Release Test
  # -----------------------------
  solr-release-test:
    name: solr-release-test (Solr ${{ matrix.solr-version }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        include:
          - solr-version: "8"
            configset: "tests/fixtures/solr_configs/8.x.x"
          - solr-version: "9"
            configset: "tests/fixtures/solr_configs/9.x.x"
    env:
      SOLR_CORE: test_core
    steps:
      # -----------------------------
      # 1. Checkout Repository
      # -----------------------------
      - name: üì• Checkout Repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      # -----------------------------
      # 2. Setup Apache Solr (Release Action)
      # -----------------------------
      - name: ‚ö° Setup Apache Solr Infrastructure (Release)
        uses: dhavalgojiya/setup-solr-action@v1
        with:
          solr-version: ${{ matrix.solr-version }}
          solr-core-name: ${{ env.SOLR_CORE }}
          solr-custom-configset-path: ${{ matrix.configset }}

      # -----------------------------
      # 3. Verify Solr is Running
      # -----------------------------
      - name: ‚úÖ Verify Solr Health
        run: |
          echo "Pinging Solr Core: ${SOLR_CORE}"
          RESPONSE=$(curl -s --fail "http://127.0.0.1:8983/solr/${SOLR_CORE}/admin/ping?wt=json")

          if echo "$RESPONSE" | grep -q '"status":"OK"'; then
            echo "üéâ Solr is healthy and responding"
          else
            echo "‚ùå Solr ping failed!"
            echo "Response: $RESPONSE"
            exit 1
          fi
